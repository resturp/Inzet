generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  LID
  COORDINATOR
  BESTUUR
}

enum TaskStatus {
  BESCHIKBAAR
  TOEGEWEZEN
  GEREED
}

enum TaskCoordinationType {
  DELEGEREN
  ORGANISEREN
}

enum OpenTaskStatus {
  OPEN
  AFGEWEZEN
}

enum NotificationCategory {
  NEW_PROPOSAL
  PROPOSAL_ACCEPTED
  TASK_CHANGED_AS_COORDINATOR
  TASK_BECAME_AVAILABLE_AS_COORDINATOR
  SUBTASK_CREATED_IN_SUBSCRIPTION
}

enum NotificationDelivery {
  OFF
  IMMEDIATE
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

model User {
  alias                   String               @id
  bondsnummer             String
  email                   String?
  emailVerifiedAt         DateTime?
  passwordHash            String?
  profilePhotoData        String?
  aboutMe                 String?
  role                    UserRole             @default(LID)
  isActive                Boolean              @default(true)
  createdAt               DateTime             @default(now())
  taskCoordinators        TaskCoordinator[]
  proposedOpenTasks       OpenTask[]           @relation("OpenTaskProposed")
  proposerOpenTasks       OpenTask[]           @relation("OpenTaskProposer")
  aliasChangeProposals    AliasChangeProposal[]
  magicLinkTokens         MagicLinkToken[]
  completedTasks          Task[]               @relation("TaskCompletedBy")
  taskSubscriptions       TaskSubscription[]
  notificationPreferences NotificationPreference[]
  notificationEvents      NotificationEvent[]

  @@index([isActive, alias])
}

model TaskTemplate {
  id               String         @id @default(cuid())
  title            String
  description      String
  defaultPoints    Int?
  parentTemplateId String?
  parentTemplate   TaskTemplate?  @relation("TemplateParent", fields: [parentTemplateId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  childTemplates   TaskTemplate[] @relation("TemplateParent")
  tasks            Task[]
  createdAt        DateTime       @default(now())
}

model Task {
  id              String            @id @default(cuid())
  title           String
  description     String
  longDescription String?
  teamName        String?
  parentId        String?
  parent          Task?             @relation("TaskParent", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  children        Task[]            @relation("TaskParent")
  ownCoordinators TaskCoordinator[]
  points          Int
  date            DateTime
  startTime       DateTime?
  endTime         DateTime
  location        String?
  templateId      String?
  template        TaskTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  status          TaskStatus        @default(BESCHIKBAAR)
  completedByAlias String?
  completedBy     User?             @relation("TaskCompletedBy", fields: [completedByAlias], references: [alias], onDelete: SetNull, onUpdate: Cascade)
  completedAt     DateTime?
  coordinationType TaskCoordinationType?
  createdAt       DateTime          @default(now())
  openTasks       OpenTask[]
  subscriptions   TaskSubscription[]

  @@index([parentId])
  @@index([status, date])
  @@index([completedByAlias, completedAt])
}

model TaskCoordinator {
  taskId    String
  userAlias String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user      User     @relation(fields: [userAlias], references: [alias], onDelete: Restrict, onUpdate: Cascade)

  @@id([taskId, userAlias])
  @@index([userAlias])
}

model OpenTask {
  id            String         @id @default(cuid())
  taskId        String
  task          Task           @relation(fields: [taskId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  proposerAlias String
  proposer      User           @relation("OpenTaskProposer", fields: [proposerAlias], references: [alias], onDelete: Restrict, onUpdate: Cascade)
  proposedAlias String?
  proposed      User?          @relation("OpenTaskProposed", fields: [proposedAlias], references: [alias], onDelete: Restrict, onUpdate: Cascade)
  status        OpenTaskStatus @default(OPEN)
  createdAt     DateTime       @default(now())

  @@unique([taskId, proposerAlias, proposedAlias, status])
  @@index([status, createdAt])
  @@index([proposerAlias, status, createdAt])
}

model AliasChangeProposal {
  id            String         @id @default(cuid())
  requesterAlias String
  requester     User           @relation(fields: [requesterAlias], references: [alias], onDelete: Cascade, onUpdate: Cascade)
  currentAlias  String
  requestedAlias String
  status        OpenTaskStatus @default(OPEN)
  createdAt     DateTime       @default(now())

  @@unique([requesterAlias, status])
  @@index([status, createdAt])
  @@index([requestedAlias, status])
}

model TaskSubscription {
  id        String   @id @default(cuid())
  taskId    String
  userAlias String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user      User     @relation(fields: [userAlias], references: [alias], onDelete: Cascade, onUpdate: Cascade)

  @@unique([taskId, userAlias])
  @@index([userAlias])
}

model NotificationPreference {
  userAlias       String
  category        NotificationCategory
  delivery        NotificationDelivery @default(OFF)
  lastDigestSentAt DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  user            User                 @relation(fields: [userAlias], references: [alias], onDelete: Cascade, onUpdate: Cascade)

  @@id([userAlias, category])
  @@index([category, delivery])
}

model NotificationEvent {
  id         String               @id @default(cuid())
  userAlias  String
  category   NotificationCategory
  subject    String
  body       String
  createdAt  DateTime             @default(now())
  deliveredAt DateTime?
  user       User                 @relation(fields: [userAlias], references: [alias], onDelete: Cascade, onUpdate: Cascade)

  @@index([userAlias, category, deliveredAt, createdAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorAlias  String
  actionType  String
  entityType  String
  entityId    String
  payloadJson String?
  createdAt   DateTime @default(now())
}

model MagicLinkToken {
  id        String    @id @default(cuid())
  userAlias String?
  user      User?     @relation(fields: [userAlias], references: [alias], onDelete: Cascade, onUpdate: Cascade)
  email     String?
  bondsnummer String?
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email, bondsnummer])
  @@index([tokenHash, usedAt, expiresAt, createdAt])
}
